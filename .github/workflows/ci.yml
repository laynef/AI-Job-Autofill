name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:
    inputs:
      run_mobile:
        description: "Run iOS/Android simulator tests (requires pre-provisioned simulators on runner)"
        required: false
        default: "false"

jobs:
  tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}/website
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Create venv
        run: python -m venv .venv
      - name: Install deps
        run: .venv/bin/pip install -r requirements.txt -r requirements-dev.txt
      - name: Run tests (unit/integration/build)
        run: .venv/bin/pytest -q -m "not e2e and not mobile"

  e2e-browser:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}/website
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Create venv
        run: python -m venv .venv
      - name: Install deps
        run: .venv/bin/pip install -r requirements.txt -r requirements-dev.txt
      - name: Install Playwright browsers
        run: .venv/bin/playwright install --with-deps
      - name: Start server
        run: .venv/bin/python -m uvicorn main:app --host 127.0.0.1 --port 8080 &
      - name: Wait for server
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8080/health >/dev/null; then
              echo "Server is up"
              exit 0
            fi
            sleep 1
          done
          echo "Server failed to start"
          exit 1
      - name: Run browser E2E
        env:
          RUN_E2E: "1"
          E2E_BASE_URL: "http://127.0.0.1:8080"
        run: .venv/bin/pytest -q -m e2e --no-cov

  mobile-simulators:
    if: ${{ github.event.inputs.run_mobile == 'true' }}
    runs-on: [self-hosted, macOS]
    defaults:
      run:
        working-directory: ${{ github.workspace }}/website
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Create venv
        run: python -m venv .venv
      - name: Install deps
        run: .venv/bin/pip install -r requirements.txt -r requirements-dev.txt
      - name: Run iOS/Android simulator tests
        env:
          RUN_IOS_SIM: "1"
          RUN_ANDROID_SIM: "1"
        run: .venv/bin/pytest -q -m mobile
